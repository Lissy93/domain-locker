<h2>User Settings</h2>

<div class="p-4 grid grid-cols-1 xl:grid-cols-2 gap-4 grid-flow-dense auto-rows-auto">
  <!-- Profile Settings Panel -->
  <p-card header="Profile Settings" styleClass="h-full">
    <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
      <div class="p-field">
        <label for="name">Full Name</label>
        <input id="name" type="text" pInputText formControlName="name" placeholder="Enter your full name" />
      </div>
      <div class="p-field">
        <label for="avatar_url">Profile Picture URL</label>
        <div class="flex flex-col w-full">
          <input id="avatar_url" type="url" pInputText formControlName="avatar_url" placeholder="Enter a valid image URL" />
          <small *ngIf="profileForm.get('avatar_url')?.invalid && profileForm.get('avatar_url')?.touched" class="p-error">
            Please enter a valid image URL.
          </small>
        </div>
      </div>
      <div class="p-field justify-end">
        <img
          *ngIf="profileForm.get('avatar_url')?.value" [src]="profileForm.get('avatar_url')?.value"
          alt="Profile Preview"
          class="rounded-full"
          width="100"
        />
      </div>
      <p-button
        type="submit"
        label="Save Profile"
        icon="pi pi-save"
        class="flex justify-end"
        [loading]="loading.profile"
        [disabled]="profileForm.invalid || loading.profile"
      />
    </form>
  </p-card>


  <!-- Email Settings Panel -->
  <p-card header="Email Settings" styleClass="h-full">
    <form [formGroup]="emailForm" (ngSubmit)="updateEmail()">
      <div class="p-field">
        <label for="email">Email</label>
        <div class="flex flex-col gap-2 w-full">
          <input id="email" type="email" pInputText formControlName="email" />
          <small *ngIf="emailForm.get('email')?.invalid && emailForm.get('email')?.touched" class="p-error">
            Please enter a valid email address.
          </small>
        </div>
      </div>
      <p-button
        type="submit"
        label="Update Email"
        icon="pi pi-save"
        class="flex justify-end"
        [loading]="loading.email"
        [disabled]="emailForm.invalid || loading.email"
      />
    </form>
  </p-card>

<!-- Password Settings Panel (spans multiple rows) -->
  <p-card [header]="hasPassword ? 'Update Password' : 'Set a Password'" class="row-span-2" styleClass="h-full">
    <form [formGroup]="passwordForm" (ngSubmit)="updatePassword()" class="flex flex-col gap-2">
      <div class="p-field" *ngIf="hasPassword">
        <label for="currentPassword">Current Password</label>
        <p-password id="currentPassword" formControlName="currentPassword" [feedback]="false"></p-password>
      </div>
      <div class="p-field">
        <label for="newPassword">New Password</label>
        <p-password id="newPassword" formControlName="newPassword" [toggleMask]="true"></p-password>
      </div>
      <div class="p-field">
        <label for="confirmPassword">Confirm New Password</label>
        <p-password id="confirmPassword" formControlName="confirmPassword" [feedback]="false"></p-password>
      </div>
      <small *ngIf="passwordForm.hasError('mismatch')" class="p-error">
        Passwords do not match.
      </small>
      <p-button
        type="submit"
        label="Update Password"
        icon="pi pi-save"
        class="flex justify-end"
        [loading]="loading.password"
        [disabled]="passwordForm.invalid || loading.password"
      />
    </form>
  </p-card>

<!-- Multi-Factor Authentication Panel (spans multiple rows) -->
  <p-card header="Multi-Factor Authentication" class="row-span-2" styleClass="h-full">
    <p-button label="Enable MFA" (click)="enableMFA()" [disabled]="loading"></p-button>
    <form [formGroup]="mfaForm" (ngSubmit)="verifyMFA()" class="my-4">
      <div class="p-field">
        <label for="otpCode">OTP Code</label>
        <p-inputOtp id="otpCode" formControlName="otpCode" [length]="6"></p-inputOtp>
      </div>
      <p-button type="submit" label="Verify MFA" [disabled]="mfaForm.invalid || loading"></p-button>
    </form>
    <p-button label="Download Backup Codes" (click)="downloadBackupCodes()" [disabled]="loading"></p-button>
    <p-button
      type="submit"
      label="Doanload Backup Codes"
      icon="pi pi-save"
      class="flex justify-end"
      [loading]="loading.backupCodes"
      [disabled]="mfaForm.invalid || loading.backupCodes"
    />
  </p-card>

<!-- Session Settings Panel -->
  <p-card header="Session Settings" styleClass="h-full">
    <form [formGroup]="sessionForm" (ngSubmit)="updateSessionTimeout()">
      <div class="p-field">
        <label for="sessionTimeout">Session Timeout (minutes)</label>
        <p-inputNumber id="sessionTimeout" formControlName="sessionTimeout"></p-inputNumber>
      </div>
      <p-button
        type="submit"
        label="Save Session Preferences"
        icon="pi pi-save"
        class="flex justify-end"
        [loading]="loading.session"
        [disabled]="sessionForm.invalid || loading.session"
      />
    </form>
  </p-card>

<!-- Account Actions Panel -->
  <p-card header="Account Actions" styleClass="h-full">
    <div class="flex gap-2">
      <a routerLink="/domains/export">
        <p-button label="Export Data" icon="pi pi pi-download" severity="info"></p-button>
      </a>
      <p-button label="Delete Account" icon="pi pi-trash" (click)="confirmDeleteAccount()" severity="danger"></p-button>
    </div>
  </p-card>
</div>
