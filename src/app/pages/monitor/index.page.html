<h1 class="text-2xl my-3">Web Monitoring</h1>

@if (!(monitorEnabled$ | async)) {
  <app-feature-not-enabled feature="domainMonitor" />
}

<div class="monitor-container" *ngIf="monitorEnabled$ | async">
  <div *ngIf="loading" class="loading-container">
    <p>Loading domains...</p>
  </div>

  <div *ngIf="!loading && domains.length > 0 && domainSummaries.length === 0">
    <p-messages severity="info">
      <ng-template pTemplate>
        <div class="flex flex-col gap-2">
          <p class="m-0 font-semibold">No monitoring data available yet</p>
          <p class="m-0" *ngIf="isSelfHosted">
            Domain monitoring is now enabled for your self-hosted instance, but no data has been collected yet.
            The monitoring cron job runs every 15 minutes to check your domains' uptime and performance.
          </p>
          <p class="m-0" *ngIf="isSelfHosted">
            If you recently updated your deployment, please ensure the <code>domain-locker-updater</code> container is running.
            You can also manually trigger monitoring by running:
          </p>
          <code *ngIf="isSelfHosted" class="bg-surface-100 dark:bg-surface-800 p-2 rounded">
            curl -X POST http://localhost:3000/api/domain-monitor
          </code>
          <p class="m-0 mt-2" *ngIf="!isSelfHosted">
            Monitoring data will appear here once your domains have been checked. This typically happens within a few minutes.
          </p>
        </div>
      </ng-template>
    </p-messages>
  </div>

  <div *ngIf="!loading && domains.length === 0">
    <p-messages severity="warn">
      <ng-template pTemplate>
        <p class="m-0">No domains available to monitor. Please add some domains first.</p>
      </ng-template>
    </p-messages>
  </div>

  <ul class="list-none p-0 m-0 flex flex-col gap-3" *ngIf="!loading && domainSummaries.length > 0">
    <li *ngFor="let summary of domainSummaries" (click)="visitDomain(summary.domainName)" class="p-card py-2 px-3 flex gap-3 items-normal">
      <a [routerLink]="['/monitor', summary.domainName]" class="flex gap-2 items-center no-underline min-w-48">
        <app-domain-favicon [domain]="summary.domainName"></app-domain-favicon>
        <h3 class="m-0 text-primary">{{ summary.domainName }}</h3>
      </a>

      <div class="flex flex-col justify-between min-w-40">
        <span class="text-sm opacity-70">Uptime</span>
        <span class="text-xl font-semibold pb-2 {{getUptimeColor(summary.uptimePercentage)}}">
          @if (isNaN(summary.uptimePercentage)) {
            N/A
          } @else {
            {{ summary.uptimePercentage.toFixed(0) }}%
          }
        </span>
      </div>

      <div class="flex flex-col justify-between min-w-80">
        <span class="text-sm opacity-70 {{ !summary.sparklineData.length  ? 'line-through' : ''}}">Response Time</span>
        <apx-chart
          *ngIf="summary.sparklineData"
          [series]="[{ data: summary.sparklineData }]"
          [chart]="sparkLineConfig.chart"
          [stroke]="{ curve: 'smooth', width: 2 }"
          [colors]= "['var(--primary-color, #60a5fa)']"
          [tooltip]="{ enabled: false }"
        ></apx-chart>
      </div>

      <div class="flex flex-col justify-between min-w-40">
        <span class="text-sm opacity-70">DNS Response</span>
        <span class="text-xl font-semibold pb-2 {{getPerformanceColor(summary.avgDnsTime, 'dns')}}">
          @if (isNaN(summary.avgDnsTime)) {
            N/A
          } @else {
            {{ summary.avgDnsTime.toFixed(0) }}ms
          }
        </span>
        
      </div>
      <div class="flex flex-col justify-between min-w-40">
        <span class="text-sm opacity-70">SSL Handshake</span>
        <span class="text-xl font-semibold pb-2 {{getPerformanceColor(summary.avgSslTime, 'ssl')}}">
          @if (isNaN(summary.avgSslTime)) {
            N/A
          } @else {
            {{ summary.avgSslTime.toFixed(0) }}ms
          }
        </span>
      </div>

      <div class="flex flex-col justify-between min-w-40">
        <span class="text-sm opacity-70">Status Codes</span>
        <apx-chart
          *ngIf="summary.responseCodeSeries.length"
          [series]="summary.responseCodeSeries"
          [chart]="donutChartConfig.chart"
          [labels]="summary.responseCodeLabels"
          [colors]="summary.responseCodeColors"
          [dataLabels]="{ enabled: false }"
          [stroke]="{ show: false }"
          [legend]="{ show: false }"
          [labels]="[]"
          [tooltip]="{
            enabled: false
          }"
        />
      </div>

      </li>
  </ul>
</div>
